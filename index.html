<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapPoster v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .serif { font-family: 'Playfair Display', serif; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 100%; height: 40px; cursor: pointer; background: none; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #e5e7eb; border-radius: 6px; }
        .poster-shadow { box-shadow: 0 40px 80px rgba(0,0,0,0.18); }
        .loader { border-top-color: #000; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-stone-50 text-zinc-900">

    <div class="min-h-screen flex flex-col md:flex-row">
        <aside class="w-full md:w-96 bg-white p-8 border-r border-stone-200 flex flex-col overflow-y-auto">
            <div class="mb-10 text-center md:text-left">
                <h1 class="serif text-4xl italic mb-1">MapPoster</h1>
                <p class="text-[10px] text-stone-400 uppercase tracking-[0.3em] font-bold">Make your city a poster</p>
            </div>

            <div class="space-y-6 flex-1">
                <div>
                    <label class="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Location</label>
                    <input id="locationInput" type="text" placeholder="e.g. Venice, Italy"
                           class="w-full border-b border-stone-300 py-2 focus:outline-none focus:border-black transition-colors bg-transparent text-lg">
                </div>

                <div>
                    <label class="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Preset Theme</label>
                    <select id="themeSelect" onchange="applyTheme()" class="w-full border border-stone-200 rounded-lg p-3 bg-stone-50 text-sm outline-none focus:ring-2 ring-stone-200">
                        <option value="noir">Noir (Classic Black)</option>
                        <option value="blueprint">Blueprint (Deep Blue)</option>
                        <option value="warm">Heritage (Cream & Brown)</option>
                        <option value="emerald">Emerald (Dark Green)</option>
                        <option value="custom">-- Custom Colors --</option>
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="flex flex-col space-y-1">
                        <span class="text-[9px] uppercase font-bold text-stone-400">BG</span>
                        <input type="color" id="bgColor" value="#000000" oninput="setCustomMode()">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <span class="text-[9px] uppercase font-bold text-stone-400">Roads</span>
                        <input type="color" id="roadColor" value="#ffffff" oninput="setCustomMode()">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <span class="text-[9px] uppercase font-bold text-stone-400">Water</span>
                        <input type="color" id="waterColor" value="#1a2a3a" oninput="setCustomMode()">
                    </div>
                </div>

                <div class="pt-6 space-y-4">
                    <button id="generateBtn" onclick="generateMap()" class="w-full bg-zinc-900 text-white py-4 rounded-xl font-semibold hover:bg-black transition-all active:scale-95 shadow-lg">
                        Generate Map
                    </button>
                    <button id="downloadBtn" onclick="downloadPoster()" class="hidden w-full border-2 border-zinc-900 text-zinc-900 py-4 rounded-xl font-semibold hover:bg-zinc-50 transition-all">
                        Download PNG
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex items-center justify-center p-6 md:p-16 relative bg-stone-100">
            <div id="loader" class="hidden absolute inset-0 bg-stone-100/90 z-10 flex flex-col items-center justify-center">
                <div class="loader ease-linear rounded-full border-2 border-t-2 border-stone-300 h-12 w-12 mb-4"></div>
                <p class="text-sm text-stone-500 font-medium">Fetching City Geometry...</p>
            </div>

            <div id="posterFrame" class="bg-white p-6 md:p-12 poster-shadow max-w-lg w-full aspect-[2/3] flex flex-col">
                <div class="flex-1 overflow-hidden relative border border-stone-100 bg-stone-50">
                    <img id="mapImage" class="w-full h-full object-cover opacity-0 transition-opacity duration-700" src="">
                </div>
                <div class="pt-8 text-center">
                    <h2 id="displayCity" class="serif text-3xl md:text-4xl mb-1 tracking-tight">Venezia</h2>
                    <p class="text-[10px] uppercase tracking-[0.5em] text-stone-400 italic">Italy &bull; 300 DPI Rendering</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const themes = {
            noir: { bg: "#000000", road: "#ffffff", water: "#1a2a3a" },
            blueprint: { bg: "#1a365d", road: "#90cdf4", water: "#2a4365" },
            warm: { bg: "#fdfaf1", road: "#4a3728", water: "#b9d9eb" },
            emerald: { bg: "#064e3b", road: "#ecfdf5", water: "#065f46" }
        };

        function applyTheme() {
            const selected = document.getElementById('themeSelect').value;
            if (selected === 'custom') return;

            document.getElementById('bgColor').value = themes[selected].bg;
            document.getElementById('roadColor').value = themes[selected].road;
            document.getElementById('waterColor').value = themes[selected].water;
        }

        function setCustomMode() {
            document.getElementById('themeSelect').value = 'custom';
        }

        async function generateMap() {
            const location = document.getElementById('locationInput').value;
            const bg = document.getElementById('bgColor').value;
            const roads = document.getElementById('roadColor').value;
            const water = document.getElementById('waterColor').value;

            const btn = document.getElementById('generateBtn');
            const dlBtn = document.getElementById('downloadBtn');
            const loader = document.getElementById('loader');
            const statusText = loader.querySelector('p'); // Get the <p> inside loader
            const mapImg = document.getElementById('mapImage');

            if (!location) return alert("Enter a city first!");

            btn.disabled = true;
            loader.classList.remove('hidden');
            mapImg.classList.add('opacity-0');

            try {
                // Step 1: Status Update
                statusText.innerText = "Downloading Map Data (OpenStreetMap)...";

                const query = `?location=${encodeURIComponent(location)}&bg=${encodeURIComponent(bg)}&roads=${encodeURIComponent(roads)}&water=${encodeURIComponent(water)}`;

                const response = await fetch(`/generate${query}`);

                // Step 2: Status Update (After fetch starts)
                statusText.innerText = "Rendering High-Res Geometry...";

                const data = await response.json();

                if (data.image) {
                    statusText.innerText = "Finalizing Artwork...";
                    mapImg.src = `data:image/png;base64,${data.image}`;
                    mapImg.classList.remove('opacity-0');
                    document.getElementById('displayCity').innerText = location.toUpperCase();
                    dlBtn.classList.remove('hidden');
                } else {
                    alert("Error: " + data.error);
                }
            } catch (err) {
                alert("Server connection error. Check your Terminal.");
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
                statusText.innerText = "Fetching City Geometry..."; // Reset for next time
            }
        }

        function downloadPoster() {
            const link = document.createElement('a');
            link.href = document.getElementById('mapImage').src;
            link.download = `${document.getElementById('displayCity').innerText.toLowerCase()}-map.png`;
            link.click();
        }
    </script>
</body>
</html>
